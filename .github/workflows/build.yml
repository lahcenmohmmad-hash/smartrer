name: Build SmartSRS Android App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üßπ Free Disk Space First
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: ‚òï Install OpenJDK 17
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
          echo "/usr/lib/jvm/java-17-openjdk-amd64/bin" >> $GITHUB_PATH

      - name: üîç Verify Java
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH
          echo "=== Java Verification ==="
          which java
          which javac
          java -version
          javac -version
          echo "JAVA_HOME: $JAVA_HOME"

      - name: üì¶ Install System Dependencies
        run: |
          sudo apt-get install -y \
            python3-pip \
            build-essential \
            git \
            python3-dev \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            unzip \
            zip \
            libltdl-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config

      - name: üîß Install Python Build Tools
        run: |
          python3 -m pip install --upgrade pip
          pip3 install --upgrade setuptools wheel
          pip3 install --upgrade "cython<3.0.0"

      - name: üöÄ Install Buildozer & P4A from Master
        run: |
          pip3 install --upgrade git+https://github.com/kivy/python-for-android.git@master
          pip3 install --upgrade git+https://github.com/kivy/buildozer.git@master

      - name: üóëÔ∏è Clean Previous Build
        run: |
          rm -rf .buildozer
          rm -rf bin

      - name: üî® Build APK with Correct Java
        env:
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
        run: |
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH
          
          echo "=== Pre-Build Check ==="
          echo "JAVA_HOME: $JAVA_HOME"
          echo "javac: $(which javac)"
          javac -version
          
          echo "=== Starting Buildozer ==="
          yes | buildozer -v android debug

      - name: üì§ Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SmartSRS-APK
          path: bin/*.apk
          retention-days: 30

      - name: üìã Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            .buildozer/
            *.log
          retention-days: 7
