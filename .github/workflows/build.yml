name: Build SmartSRS Android App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ§¹ Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: ðŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            build-essential \
            git \
            python3-dev \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            unzip \
            zip \
            libltdl-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config

      - name: ðŸ”§ Verify Java Installation
        run: |
          echo "=== Java Information ==="
          which java
          which javac
          java -version
          javac -version
          echo "JAVA_HOME: $JAVA_HOME"
          ls -la $JAVA_HOME/bin/

      - name: ðŸ”§ Install Python Build Tools
        run: |
          python3 -m pip install --upgrade pip
          pip3 install --upgrade setuptools wheel
          pip3 install --upgrade "cython<3.0.0"

      - name: ðŸš€ Install Buildozer & P4A from Master
        run: |
          pip3 install --upgrade git+https://github.com/kivy/python-for-android.git@master
          pip3 install --upgrade git+https://github.com/kivy/buildozer.git@master

      - name: ðŸ—‘ï¸ Clean Previous Build
        run: |
          rm -rf .buildozer
          rm -rf bin

      - name: ðŸ“ Verify buildozer.spec exists
        run: |
          if [ ! -f buildozer.spec ]; then
            echo "ERROR: buildozer.spec not found!"
            exit 1
          fi
          echo "buildozer.spec found âœ“"

      - name: ðŸ”¨ Build APK
        run: |
          export JAVA_HOME="${JAVA_HOME}"
          export PATH="$JAVA_HOME/bin:$PATH"
          
          echo "=== Environment Check ==="
          echo "JAVA_HOME: $JAVA_HOME"
          echo "PATH: $PATH"
          echo "javac location: $(which javac)"
          
          echo "=== Starting Build ==="
          yes | buildozer -v android debug || {
            echo "=== Build Failed - Checking Logs ==="
            if [ -d .buildozer/android/platform/build-* ]; then
              echo "Build directory contents:"
              ls -la .buildozer/android/platform/build-*/
            fi
            exit 1
          }

      - name: ðŸ“¤ Upload APK Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SmartSRS-APK
          path: bin/*.apk
          retention-days: 30

      - name: ðŸ“‹ Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            .buildozer/
            *.log
          retention-days: 7
