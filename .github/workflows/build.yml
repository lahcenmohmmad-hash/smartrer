name: Build SmartSRS Android App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ”§ Setup Java Environment Variables (echo to GITHUB_ENV)
        run: |
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV
          echo "Java version (setup step):"
          java -version || true
          javac -version || true

      - name: ðŸ§¹ Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: ðŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            build-essential \
            git \
            python3-dev \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            unzip \
            zip \
            libltdl-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            openjdk-17-jdk-headless

      - name: ðŸ”§ Ensure JAVA_HOME points to apt-installed JDK (if present)
        run: |
          if [ -d "/usr/lib/jvm/java-17-openjdk-amd64" ]; then
            echo "Using apt-installed OpenJDK at /usr/lib/jvm/java-17-openjdk-amd64"
            echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
            echo "PATH=/usr/lib/jvm/java-17-openjdk-amd64/bin:$PATH" >> $GITHUB_ENV
          fi

      - name: ðŸ”§ Install Python Build Tools
        run: |
          python3 -m pip install --upgrade pip
          pip3 install --upgrade setuptools wheel
          pip3 install --upgrade "cython<3.0.0"

      - name: ðŸš€ Install Buildozer & P4A from Master
        run: |
          pip3 install --upgrade git+https://github.com/kivy/python-for-android.git@master
          pip3 install --upgrade git+https://github.com/kivy/buildozer.git@master

      - name: ðŸ—‘ï¸ Clean Previous Build
        run: |
          rm -rf .buildozer
          rm -rf bin

      - name: ðŸ“ Create buildozer.spec if missing
        run: |
          if [ ! -f buildozer.spec ]; then
            echo "Creating buildozer.spec..."
            buildozer init
          fi

      - name: ðŸ”Ž Debug: show Java / Javac presence before build
        run: |
          echo "JAVA_HOME: $JAVA_HOME"
          echo "PATH: $PATH"
          which java || true
          which javac || true
          java -version || true
          javac -version || true

      - name: ðŸ”¨ Build APK with Environment Variables
        env:
          # ANDROID paths remain as in original; JAVA_HOME/PATH already set via GITHUB_ENV
          ANDROID_SDK_ROOT: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
          ANDROID_NDK_ROOT: ${{ github.workspace }}/.buildozer/android/platform/android-ndk-r25b
        run: |
          echo "Building with JAVA_HOME: $JAVA_HOME"
          echo "PATH: $PATH"
          # Ø§Ù„Ø®ÙŠØ§Ø± yes Ù‡Ù†Ø§ ÙŠØ¬ÙŠØ¨ "y" Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ØªÙØ§Ø¹Ù„ÙŠ Ù‚Ø¯ ÙŠØ·Ø±Ø£Ø› Ø¥Ù† Ø£Ø±Ø¯Øª Ø§Ø²Ø§Ù„ØªÙ‡ ÙØ§Ø­Ø°ÙÙ‡
          yes | buildozer -v android debug

      - name: ðŸ“¤ Upload APK Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: SmartSRS-APK
          path: bin/*.apk
          retention-days: 30

      - name: ðŸ“‹ Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: .buildozer/android/platform/build-*/
          retention-days: 7
